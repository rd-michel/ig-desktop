name: Update Homebrew Cask

on:
    release:
        types: [released]

jobs:
    update-cask:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Get release version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Download and calculate SHA256
              id: sha256
              run: |
                  DOWNLOAD_URL="https://github.com/inspektor-gadget/ig-desktop/releases/download/v${{ steps.version.outputs.version }}/ig-desktop-macos.app.zip"
                  curl -L -o ig-desktop-macos.app.zip "$DOWNLOAD_URL"
                  SHA256=$(shasum -a 256 ig-desktop-macos.app.zip | awk '{print $1}')
                  echo "sha256=$SHA256" >> $GITHUB_OUTPUT
                  rm ig-desktop-macos.app.zip

            - name: Update Cask formula
              run: |
                  sed -i "s/version \".*\"/version \"${{ steps.version.outputs.version }}\"/" Cask/ig-desktop.rb
                  sed -i "s/sha256 .*/sha256 \"${{ steps.sha256.outputs.sha256 }}\"/" Cask/ig-desktop.rb

            - name: Create Pull Request
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  BRANCH="update-cask-v${{ steps.version.outputs.version }}"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git checkout -b "$BRANCH"
                  git add Cask/ig-desktop.rb
                  git commit -m "chore: update Homebrew Cask to v${{ steps.version.outputs.version }}"
                  git push origin "$BRANCH"
                  gh pr create \
                    --title "Update Homebrew Cask to v${{ steps.version.outputs.version }}" \
                    --body "This PR updates the Homebrew Cask formula to version ${{ steps.version.outputs.version }}.

                  **Changes:**
                  - Version: ${{ steps.version.outputs.version }}
                  - SHA256: ${{ steps.sha256.outputs.sha256 }}

                  This PR was automatically generated by the release workflow." \
                    --base main \
                    --head "$BRANCH"
